<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="screen-orientation" content="landscape">
  <title>Cabezones - Kompite Gatillazo 2.0</title>
  <link rel="stylesheet" href="/css/mobile-first.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%); 
      color: #fff; 
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
      min-height: 100vh;
    }
    
    /* Landscape Lock Overlay */
    #landscapeOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: linear-gradient(135deg, #0d0d2b 0%, #1a0a2e 100%);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 10000;
      text-align: center;
      padding: 20px;
    }
    #landscapeOverlay .rotate-icon {
      font-size: 80px;
      animation: rotatePhone 2s infinite ease-in-out;
      margin-bottom: 20px;
    }
    @keyframes rotatePhone {
      0%, 100% { transform: rotate(0deg); }
      50% { transform: rotate(90deg); }
    }
    #landscapeOverlay h2 { 
      color: #00f5ff; 
      font-size: 24px; 
      margin-bottom: 10px;
      text-shadow: 0 0 20px #00f5ff;
    }
    #landscapeOverlay p { color: #888; font-size: 16px; }
    
    /* Waiting Room */
    #waitingRoom {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: linear-gradient(135deg, #0d0d2b 0%, #1a0a2e 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 9000;
    }
    #waitingRoom.hidden { display: none; }
    .waiting-content {
      text-align: center;
      padding: 40px;
      background: rgba(0,245,255,0.05);
      border: 2px solid rgba(0,245,255,0.3);
      border-radius: 20px;
      max-width: 400px;
    }
    .waiting-spinner {
      width: 80px; height: 80px;
      border: 4px solid rgba(0,245,255,0.2);
      border-top-color: #00f5ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .waiting-status { color: #00f5ff; font-size: 24px; margin-bottom: 10px; }
    .waiting-sub { color: #888; font-size: 14px; }
    .queue-position { 
      background: linear-gradient(135deg, #00f5ff, #bf00ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 48px;
      font-weight: bold;
      margin: 20px 0;
    }
    .soft-lock-info {
      background: rgba(255,215,0,0.1);
      border: 1px solid rgba(255,215,0,0.3);
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
    }
    .soft-lock-info h4 { color: #ffd700; margin-bottom: 5px; }
    .soft-lock-info p { color: #ccc; font-size: 12px; }
    
    /* Game Header */
    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(10px);
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 100;
    }
    .back-btn {
      color: #00f5ff;
      text-decoration: none;
      font-size: 18px;
      padding: 8px 16px;
      background: rgba(0,245,255,0.1);
      border-radius: 8px;
    }
    .game-header h1 { font-size: 20px; color: #fff; }
    .connection-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      background: rgba(255,0,0,0.3);
    }
    .connection-status.connected { background: rgba(0,255,0,0.3); }
    
    /* Score Display */
    .score-container {
      position: fixed;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 20px;
      z-index: 99;
      background: rgba(0,0,0,0.7);
      padding: 10px 30px;
      border-radius: 30px;
      border: 2px solid rgba(0,245,255,0.3);
    }
    .score { font-size: 48px; font-weight: bold; }
    .score.p1 { color: #00f5ff; text-shadow: 0 0 20px #00f5ff; }
    .score.p2 { color: #ff00bf; text-shadow: 0 0 20px #ff00bf; }
    .score-divider { color: #666; font-size: 36px; }
    .timer {
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #ffd700, #ff8c00);
      padding: 5px 15px;
      border-radius: 15px;
      font-size: 14px;
      font-weight: bold;
      color: #000;
    }
    
    /* Game Canvas */
    .game-container {
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding-top: 50px;
    }
    #gameCanvas {
      width: 100%;
      max-width: 1024px;
      height: 60vh;
      background: linear-gradient(180deg, #1e3a1e 0%, #0d1f0d 100%);
      border: 3px solid rgba(0,245,255,0.5);
      border-radius: 12px;
      position: relative;
      box-shadow: 0 0 40px rgba(0,245,255,0.2), inset 0 0 100px rgba(0,0,0,0.5);
    }
    #canvas {
      width: 100%;
      height: 100%;
      border-radius: 10px;
    }
    
    /* Controls */
    .controls-container {
      position: fixed;
      bottom: 20px;
      left: 0; right: 0;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      padding: 0 20px;
      z-index: 100;
    }
    .joystick-zone {
      width: 140px;
      height: 140px;
      background: radial-gradient(circle, rgba(0,245,255,0.2) 0%, rgba(0,245,255,0.05) 100%);
      border: 3px solid rgba(0,245,255,0.4);
      border-radius: 50%;
      position: relative;
    }
    .joystick-knob {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #00f5ff, #0088ff);
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 20px rgba(0,245,255,0.5);
    }
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .action-btn {
      min-width: 100px;
      min-height: 70px;
      border: none;
      border-radius: 15px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.1s;
      text-transform: uppercase;
    }
    .action-btn:active { transform: scale(0.95); }
    .btn-jump {
      background: linear-gradient(135deg, #00f5ff, #0088ff);
      color: #000;
      box-shadow: 0 0 20px rgba(0,245,255,0.5);
    }
    .btn-kick {
      background: linear-gradient(135deg, #ff00bf, #ff0066);
      color: #fff;
      box-shadow: 0 0 20px rgba(255,0,191,0.5);
    }
    
    /* Match Result Modal */
    #resultModal {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 11000;
    }
    .result-content {
      text-align: center;
      padding: 40px;
      background: linear-gradient(135deg, rgba(0,245,255,0.1), rgba(191,0,255,0.1));
      border: 2px solid rgba(0,245,255,0.5);
      border-radius: 20px;
      max-width: 400px;
    }
    .result-title { font-size: 36px; margin-bottom: 20px; }
    .result-title.winner { color: #ffd700; text-shadow: 0 0 30px #ffd700; }
    .result-title.loser { color: #ff4444; }
    .result-score { font-size: 48px; margin: 20px 0; }
    .result-earnings {
      background: rgba(0,255,0,0.1);
      border: 1px solid rgba(0,255,0,0.3);
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
    }
    .result-earnings h4 { color: #00ff00; }
    .result-btn {
      background: linear-gradient(135deg, #00f5ff, #bf00ff);
      color: #fff;
      border: none;
      padding: 15px 40px;
      border-radius: 30px;
      font-size: 18px;
      cursor: pointer;
      margin-top: 20px;
    }
    
    /* Reconnection Overlay */
    .reconnection-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10500;
    }
    .reconnection-modal {
      text-align: center;
      padding: 40px;
      background: rgba(255,0,0,0.1);
      border: 2px solid rgba(255,0,0,0.5);
      border-radius: 20px;
    }
    .reconnection-modal .spinner {
      width: 60px; height: 60px;
      border: 4px solid rgba(255,0,0,0.2);
      border-top-color: #ff0000;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
  </style>
</head>
<body>
  <!-- Landscape Lock Overlay -->
  <div id="landscapeOverlay">
    <div class="rotate-icon">üì±</div>
    <h2>Gira tu dispositivo</h2>
    <p>Por favor, usa el modo horizontal para jugar Cabezones</p>
  </div>

  <!-- Waiting Room -->
  <div id="waitingRoom">
    <div class="waiting-content">
      <div class="waiting-spinner"></div>
      <div class="waiting-status" id="waitingStatus">Conectando al servidor...</div>
      <div class="waiting-sub" id="waitingSub">Preparando la arena de juego</div>
      <div class="queue-position" id="queuePosition" style="display:none;">1</div>
      <div class="soft-lock-info">
        <h4>üîí Soft Lock: 5 LKC</h4>
        <p>Se bloquear√°n 5 LKC de tu balance al encontrar rival.<br>El ganador recibe el pot menos 8% de rake.</p>
      </div>
    </div>
  </div>

  <!-- Game Header -->
  <header class="game-header">
    <a href="/" class="back-btn">‚Üê Lobby</a>
    <h1>‚öΩ Cabezones</h1>
    <div class="connection-status" id="connStatus">üî¥ Offline</div>
  </header>

  <!-- Score Display -->
  <div class="score-container" id="scoreContainer" style="display:none;">
    <div class="timer" id="gameTimer">01:00</div>
    <span class="score p1" id="p1Score">0</span>
    <span class="score-divider">-</span>
    <span class="score p2" id="p2Score">0</span>
  </div>

  <!-- Game Canvas -->
  <main class="game-container">
    <div id="gameCanvas">
      <canvas id="canvas" width="1024" height="576"></canvas>
    </div>
  </main>

  <!-- Controls -->
  <div class="controls-container" id="controls" style="display:none;">
    <div class="joystick-zone" id="joystickZone">
      <div class="joystick-knob" id="joystickKnob"></div>
    </div>
    <div class="action-buttons">
      <button class="action-btn btn-jump" id="jumpBtn">‚¨ÜÔ∏è SALTAR</button>
      <button class="action-btn btn-kick" id="kickBtn">‚öΩ PATEAR</button>
    </div>
  </div>

  <!-- Result Modal -->
  <div id="resultModal">
    <div class="result-content">
      <h2 class="result-title" id="resultTitle">¬°VICTORIA!</h2>
      <div class="result-score" id="resultScore">3 - 1</div>
      <div class="result-earnings" id="resultEarnings">
        <h4>+9.2 LKC</h4>
        <p>Pot: 10 LKC | Rake 8%: 0.8 LKC</p>
      </div>
      <button class="result-btn" onclick="location.href='/'">Volver al Lobby</button>
    </div>
  </div>

  <!-- Reconnection Overlay -->
  <div class="reconnection-overlay" id="reconnectOverlay">
    <div class="reconnection-modal">
      <div class="spinner"></div>
      <h2>Reconectando...</h2>
      <p>Tiempo restante: <span id="reconnectTimer">30</span>s</p>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // KOMPITE CABEZONES CLIENT - GATILLAZO 2.0
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const GAME_TYPE = 'cabezones';
    const SERVER = 'http://194.113.194.85:8000';
    const SOFT_LOCK_AMOUNT = 5;
    const GAME_DURATION = 60000;
    const RAKE_PERCENTAGE = 0.08;
    
    let userId = localStorage.getItem('kompite_userId') || 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
    let authToken = localStorage.getItem('kompite_token') || null;
    localStorage.setItem('kompite_userId', userId);
    
    let socket = null;
    let currentMatch = null;
    let gameStartTime = null;
    let gameTimer = null;
    let isPlaying = false;
    let myPlayerSlot = null;
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // LANDSCAPE DETECTION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function checkOrientation() {
      const isLandscape = window.innerWidth > window.innerHeight;
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      document.getElementById('landscapeOverlay').style.display = (isMobile && !isLandscape) ? 'flex' : 'none';
    }
    
    window.addEventListener('resize', checkOrientation);
    window.addEventListener('orientationchange', checkOrientation);
    checkOrientation();
    
    if (screen.orientation && screen.orientation.lock) {
      screen.orientation.lock('landscape').catch(() => {});
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SOCKET CONNECTION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function initSocket() {
      socket = io(SERVER, {
        auth: { userId, token: authToken, gameType: GAME_TYPE },
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionAttempts: 10,
        reconnectionDelay: 1000
      });
      
      socket.on('connect', () => {
        console.log('üü¢ Socket.io connect event');
        updateConnectionStatus(true);
        hideReconnectOverlay();
        updateWaitingStatus('Conectando...', 'Esperando confirmaci√≥n');
        
        // Fallback: si no recibimos 'connected' en 2 segundos, unirse a la cola directamente
        setTimeout(() => {
          if (!isPlaying && !currentMatch) {
            console.log('‚ö†Ô∏è Timeout esperando evento connected, uniendo a cola...');
            joinMatchmaking();
          }
        }, 2000);
      });
      
      // Evento cuando el servidor confirma la conexi√≥n y nos da nuestro userId
      socket.on('connected', (data) => {
        console.log('üîó Servidor confirm√≥ conexi√≥n:', data);
        console.log('üîó userId actual:', userId);
        // Actualizar userId con el que el servidor nos asign√≥
        if (data.userId && data.userId !== userId) {
          console.log('üìù Actualizando userId:', userId, '->', data.userId);
          userId = data.userId;
          localStorage.setItem('kompite_userId', userId);
        }
        console.log('üîó Llamando joinMatchmaking()...');
        updateWaitingStatus('Conectado! Buscando rival...', 'Entrando en cola');
        joinMatchmaking();
      });
      
      socket.on('disconnect', () => {
        console.log('üî¥ Desconectado');
        updateConnectionStatus(false);
        if (isPlaying) showReconnectOverlay();
      });
      
      socket.on('queueJoined', (data) => {
        console.log('üìã En cola:', data);
        updateWaitingStatus('Esperando Rival...', 'Posici√≥n: ' + (data.queuePosition || 1));
        document.getElementById('queuePosition').style.display = 'block';
        document.getElementById('queuePosition').textContent = data.queuePosition || '1';
      });
      
      socket.on('matchFound', async (data) => {
        console.log('üéÆ Match encontrado:', data);
        console.log('üéÆ Data completa:', JSON.stringify(data, null, 2));
        currentMatch = data;
        myPlayerSlot = data.players[0] === userId ? 'p1' : 'p2';
        console.log('üë§ Mi userId:', userId);
        console.log('üë§ Players:', data.players);
        console.log('üë§ Soy jugador:', myPlayerSlot, 'matchId:', data.matchId);
        updateWaitingStatus('¬°Rival encontrado!', data.isBot ? '(vs Bot)' : 'Iniciando...');
        const lockOk = await executeSoftLock();
        console.log('üîí SoftLock result:', lockOk);
        if (lockOk !== false) {
          console.log('üöÄ Iniciando juego...');
          startGame(data);
        }
      });
      
      socket.on('gameState', (state) => {
        if (!isPlaying) {
          console.log('‚ö†Ô∏è gameState recibido pero isPlaying=false');
          return; // Ignorar estados si el juego no est√° activo
        }
        updateGameState(state);
      });
      
      socket.on('matchEnded', (result) => {
        console.log('üèÅ Partido terminado:', result);
        isPlaying = false;
        endGame(result);
      });
      
      // Manejo de errores
      socket.on('error', (error) => {
        console.error('‚ùå Error socket:', error);
      });
      
      socket.on('connect_error', (error) => {
        console.error('‚ùå Error conexi√≥n:', error);
        updateConnectionStatus(false);
      });
    }
    
    function joinMatchmaking() {
      console.log('üìã joinMatchmaking() llamado');
      console.log('üìã Socket connected:', socket.connected);
      console.log('üìã GAME_TYPE:', GAME_TYPE);
      socket.emit('joinQueue', { gameType: GAME_TYPE }, (response) => {
        console.log('üìã Queue response:', response);
        if (response?.error) updateWaitingStatus('Error', response.error);
      });
    }
    
    async function executeSoftLock() {
      try {
        const res = await fetch(SERVER + '/match/soft-lock', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': authToken ? 'Bearer ' + authToken : '' },
          body: JSON.stringify({ userId, gameType: GAME_TYPE, matchId: currentMatch?.matchId })
        });
        const data = await res.json();
        console.log('üîí SoftLock:', data);
        if (!data.success) { alert('Balance insuficiente'); location.href = '/'; return false; }
        return true;
      } catch (err) { console.error(err); return false; }
    }
    
    function startGame(matchData) {
      hideWaitingRoom();
      showGameUI();
      isPlaying = true;
      gameStartTime = Date.now();
      
      gameTimer = setInterval(() => {
        const remaining = Math.max(0, GAME_DURATION - (Date.now() - gameStartTime));
        const secs = Math.ceil(remaining / 1000);
        document.getElementById('gameTimer').textContent = 
          String(Math.floor(secs/60)).padStart(2,'0') + ':' + String(secs%60).padStart(2,'0');
        if (remaining <= 0) clearInterval(gameTimer);
      }, 100);
      
      initGameCanvas();
    }
    
    async function endGame(result) {
      isPlaying = false;
      clearInterval(gameTimer);
      
      const isWinner = result.winnerId === userId;
      const pot = SOFT_LOCK_AMOUNT * 2;
      const rake = pot * RAKE_PERCENTAGE;
      const winnings = pot - rake;
      
      const modal = document.getElementById('resultModal');
      const title = document.getElementById('resultTitle');
      const earnings = document.getElementById('resultEarnings');
      
      title.textContent = isWinner ? '¬°VICTORIA!' : 'DERROTA';
      title.className = 'result-title ' + (isWinner ? 'winner' : 'loser');
      earnings.innerHTML = isWinner 
        ? '<h4>+' + winnings.toFixed(1) + ' LKC</h4><p>Pot: ' + pot + ' | Rake: ' + rake.toFixed(1) + '</p>'
        : '<h4>-' + SOFT_LOCK_AMOUNT + ' LKC</h4><p>Mejor suerte la pr√≥xima</p>';
      document.getElementById('resultScore').textContent = (result.p1Score||0) + ' - ' + (result.p2Score||0);
      modal.style.display = 'flex';
    }
    
    function updateConnectionStatus(c) {
      const s = document.getElementById('connStatus');
      s.textContent = c ? 'üü¢ Online' : 'üî¥ Offline';
      s.className = 'connection-status' + (c ? ' connected' : '');
    }
    function updateWaitingStatus(m, s) {
      document.getElementById('waitingStatus').textContent = m;
      document.getElementById('waitingSub').textContent = s || '';
    }
    function hideWaitingRoom() { document.getElementById('waitingRoom').classList.add('hidden'); }
    function showGameUI() {
      document.getElementById('scoreContainer').style.display = 'flex';
      document.getElementById('controls').style.display = 'flex';
    }
    function showReconnectOverlay() {
      document.getElementById('reconnectOverlay').style.display = 'flex';
      let t = 30;
      const i = setInterval(() => {
        t--;
        document.getElementById('reconnectTimer').textContent = t;
        if (t <= 0 || socket.connected) { clearInterval(i); if (t <= 0) location.href = '/'; }
      }, 1000);
    }
    function hideReconnectOverlay() { document.getElementById('reconnectOverlay').style.display = 'none'; }
    
    function updateGameState(state) {
      // Actualizar scores
      document.getElementById('p1Score').textContent = state.p1Score ?? state.p1?.score ?? 0;
      document.getElementById('p2Score').textContent = state.p2Score ?? state.p2?.score ?? 0;
      
      // Actualizar timer desde el servidor
      if (state.timeLeft !== undefined) {
        const secs = Math.ceil(state.timeLeft / 1000);
        const mins = Math.floor(secs / 60);
        const secsRemaining = secs % 60;
        document.getElementById('gameTimer').textContent = 
          String(mins).padStart(2,'0') + ':' + String(secsRemaining).padStart(2,'0');
      }
      
      // Renderizar el juego
      if (state.ball || state.p1 || state.p2) {
        renderGame(state);
      }
    }
    
    let ctx = null, lastState = null;
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CARGA DE SPRITES DE PERSONAJES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const ASSETS_PATH = '/js/games/cabezones/client/assets/';
    const sprites = {
      pitch: new Image(),
      // Son Heung-min
      son: { right: new Image(), left: new Image(), kickRight: new Image(), kickLeft: new Image() },
      // Benzema
      benzema: { right: new Image(), left: new Image(), kickRight: new Image(), kickLeft: new Image() },
      // Mbapp√©  
      mbappe: { right: new Image(), left: new Image(), kickRight: new Image(), kickLeft: new Image() }
    };
    let spritesLoaded = false;
    
    function loadSprites() {
      return new Promise((resolve) => {
        let loaded = 0;
        const total = 13;
        
        const onLoad = () => { loaded++; if (loaded >= total) { spritesLoaded = true; resolve(); } };
        const onError = (e) => { console.warn('Sprite error:', e.target.src); onLoad(); };
        
        // Pitch
        sprites.pitch.onload = onLoad; sprites.pitch.onerror = onError;
        sprites.pitch.src = ASSETS_PATH + 'pitch_night.png';
        
        // Son
        sprites.son.right.onload = onLoad; sprites.son.right.onerror = onError;
        sprites.son.right.src = ASSETS_PATH + 'son.png';
        sprites.son.left.onload = onLoad; sprites.son.left.onerror = onError;
        sprites.son.left.src = ASSETS_PATH + 'son_flipped.png';
        sprites.son.kickRight.onload = onLoad; sprites.son.kickRight.onerror = onError;
        sprites.son.kickRight.src = ASSETS_PATH + 'kicking_son.png';
        sprites.son.kickLeft.onload = onLoad; sprites.son.kickLeft.onerror = onError;
        sprites.son.kickLeft.src = ASSETS_PATH + 'kicking_son_flipped.png';
        
        // Benzema
        sprites.benzema.right.onload = onLoad; sprites.benzema.right.onerror = onError;
        sprites.benzema.right.src = ASSETS_PATH + 'benzema_shoe_right.png';
        sprites.benzema.left.onload = onLoad; sprites.benzema.left.onerror = onError;
        sprites.benzema.left.src = ASSETS_PATH + 'benzema_shoe_left.png';
        sprites.benzema.kickRight.onload = onLoad; sprites.benzema.kickRight.onerror = onError;
        sprites.benzema.kickRight.src = ASSETS_PATH + 'benzema_shoe_up_right.png';
        sprites.benzema.kickLeft.onload = onLoad; sprites.benzema.kickLeft.onerror = onError;
        sprites.benzema.kickLeft.src = ASSETS_PATH + 'benzema_shoe_up_left.png';
        
        // Mbapp√©
        sprites.mbappe.right.onload = onLoad; sprites.mbappe.right.onerror = onError;
        sprites.mbappe.right.src = ASSETS_PATH + 'mbappe_shoe_right.png';
        sprites.mbappe.left.onload = onLoad; sprites.mbappe.left.onerror = onError;
        sprites.mbappe.left.src = ASSETS_PATH + 'mbappe_shoe_left.png';
        sprites.mbappe.kickRight.onload = onLoad; sprites.mbappe.kickRight.onerror = onError;
        sprites.mbappe.kickRight.src = ASSETS_PATH + 'mbappe_shoe_up_right.png';
        sprites.mbappe.kickLeft.onload = onLoad; sprites.mbappe.kickLeft.onerror = onError;
        sprites.mbappe.kickLeft.src = ASSETS_PATH + 'mbappe_shoe_up_left.png';
        
        // Timeout fallback
        setTimeout(() => { if (!spritesLoaded) { spritesLoaded = true; resolve(); } }, 3000);
      });
    }
    
    // Personajes asignados (P1 siempre izquierda, P2 siempre derecha)
    let p1Character = 'son';
    let p2Character = 'benzema';
    
    function initGameCanvas() {
      ctx = document.getElementById('canvas').getContext('2d');
      loadSprites().then(() => {
        console.log('‚úÖ Sprites cargados');
        requestAnimationFrame(renderLoop);
      });
    }
    function renderLoop() {
      if (!isPlaying) return;
      if (lastState) renderGame(lastState);
      requestAnimationFrame(renderLoop);
    }
    function renderGame(state) {
      lastState = state;
      if (!ctx) return;
      const W = ctx.canvas.width, H = ctx.canvas.height;
      
      // Dibujar fondo (pitch o gradiente)
      if (spritesLoaded && sprites.pitch.complete && sprites.pitch.naturalWidth > 0) {
        ctx.drawImage(sprites.pitch, 0, 0, W, H);
      } else {
        ctx.fillStyle = '#1a472a'; ctx.fillRect(0, 0, W, H);
      }
      
      // L√≠neas del campo
      ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(W/2, 0); ctx.lineTo(W/2, H); ctx.stroke();
      ctx.beginPath(); ctx.arc(W/2, H/2, 80, 0, Math.PI*2); ctx.stroke();
      
      // Porter√≠as
      ctx.fillStyle = 'rgba(0,245,255,0.3)'; ctx.fillRect(0, H/2-80, 20, 160);
      ctx.fillStyle = 'rgba(255,0,191,0.3)'; ctx.fillRect(W-20, H/2-80, 20, 160);
      
      // Bal√≥n
      if (state.ball) {
        ctx.beginPath(); ctx.arc(state.ball.x, state.ball.y, 15, 0, Math.PI*2);
        ctx.fillStyle = '#fff'; ctx.fill(); 
        ctx.strokeStyle = '#333'; ctx.lineWidth = 2; ctx.stroke();
        // Efecto de brillo
        ctx.beginPath(); ctx.arc(state.ball.x-5, state.ball.y-5, 4, 0, Math.PI*2);
        ctx.fillStyle = 'rgba(255,255,255,0.6)'; ctx.fill();
      }
      
      // Jugadores con sprites
      const p1Data = state.p1 || { x: 200, y: 450, kicking: false, facingRight: true };
      const p2Data = state.p2 || { x: 824, y: 450, kicking: false, facingRight: false };
      
      drawPlayer(p1Data.x || 200, p1Data.y || 450, p1Character, p1Data.isKicking || p1Data.kicking, p1Data.facingRight !== false, 'P1');
      drawPlayer(p2Data.x || 824, p2Data.y || 450, p2Character, p2Data.isKicking || p2Data.kicking, p2Data.facingRight === true, 'P2');
    }
    
    function drawPlayer(x, y, character, isKicking, facingRight, label) {
      const charSprites = sprites[character] || sprites.son;
      const PLAYER_SIZE = 100;
      
      let sprite;
      if (isKicking) {
        sprite = facingRight ? charSprites.kickRight : charSprites.kickLeft;
      } else {
        sprite = facingRight ? charSprites.right : charSprites.left;
      }
      
      // Dibujar sprite si est√° cargado
      if (spritesLoaded && sprite && sprite.complete && sprite.naturalWidth > 0) {
        ctx.drawImage(sprite, x - PLAYER_SIZE/2, y - PLAYER_SIZE, PLAYER_SIZE, PLAYER_SIZE);
      } else {
        // Fallback: dibujar personaje simple con colores
        const color = label === 'P1' ? '#00f5ff' : '#ff00bf';
        // Cabeza
        ctx.beginPath(); ctx.arc(x, y - 60, 30, 0, Math.PI*2);
        ctx.fillStyle = color; ctx.fill(); 
        ctx.strokeStyle = '#fff'; ctx.lineWidth = 3; ctx.stroke();
        // Cuerpo
        ctx.fillStyle = color;
        ctx.fillRect(x - 15, y - 30, 30, 40);
        // Piernas
        ctx.fillRect(x - 12, y + 10, 10, 25);
        ctx.fillRect(x + 2, y + 10, 10, 25);
        // Ojos
        ctx.fillStyle = '#fff';
        ctx.beginPath(); ctx.arc(x - 10, y - 65, 5, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(x + 10, y - 65, 5, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#000';
        ctx.beginPath(); ctx.arc(x - 10, y - 65, 2, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(x + 10, y - 65, 2, 0, Math.PI*2); ctx.fill();
      }
      
      // Etiqueta del jugador
      ctx.fillStyle = label === 'P1' ? '#00f5ff' : '#ff00bf';
      ctx.font = 'bold 14px sans-serif'; 
      ctx.textAlign = 'center'; 
      ctx.fillText(label, x, y - PLAYER_SIZE - 10);
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CONTROLS - Joystick, Buttons & Keyboard
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const jz = document.getElementById('joystickZone'), jk = document.getElementById('joystickKnob');
    let ja = false, jc = {x:0,y:0};
    let currentMoveX = 0;
    
    // Funci√≥n para enviar acciones al servidor
    function sendAction(action, data = {}) {
      if (!isPlaying || !currentMatch?.matchId) {
        console.warn('‚ö†Ô∏è No se puede enviar acci√≥n:', { isPlaying, matchId: currentMatch?.matchId });
        return;
      }
      socket.emit('gameAction', { 
        matchId: currentMatch.matchId, 
        action, 
        data 
      }, (response) => {
        if (response?.error) {
          console.error('‚ùå Error en acci√≥n:', response.error);
        }
      });
    }
    
    // Touch Controls - Joystick
    jz.addEventListener('touchstart', e => { 
      e.preventDefault(); 
      ja = true; 
      const r = jz.getBoundingClientRect(); 
      jc = {x:r.left+r.width/2, y:r.top+r.height/2}; 
    });
    jz.addEventListener('touchmove', e => {
      e.preventDefault(); 
      if (!ja) return;
      const t = e.touches[0]; 
      let dx = t.clientX - jc.x, dy = t.clientY - jc.y;
      const d = Math.sqrt(dx*dx+dy*dy), m = 50;
      if (d > m) { dx = dx/d*m; dy = dy/d*m; }
      jk.style.transform = 'translate(calc(-50% + '+dx+'px), calc(-50% + '+dy+'px))';
      currentMoveX = dx/m;
      sendAction('move', {dx: currentMoveX, dy: 0});
    });
    jz.addEventListener('touchend', () => {
      ja = false; 
      jk.style.transform = 'translate(-50%, -50%)';
      currentMoveX = 0;
      sendAction('move', {dx: 0, dy: 0});
    });
    
    // Touch Controls - Buttons
    document.getElementById('jumpBtn').addEventListener('touchstart', e => {
      e.preventDefault(); 
      sendAction('jump', {});
    });
    document.getElementById('kickBtn').addEventListener('touchstart', e => {
      e.preventDefault(); 
      sendAction('kick', {});
    });
    
    // Mouse Controls (for desktop testing)
    jz.addEventListener('mousedown', e => { 
      ja = true; 
      const r = jz.getBoundingClientRect(); 
      jc = {x:r.left+r.width/2, y:r.top+r.height/2}; 
    });
    document.addEventListener('mousemove', e => {
      if (!ja) return;
      let dx = e.clientX - jc.x;
      const m = 50;
      if (Math.abs(dx) > m) dx = dx > 0 ? m : -m;
      jk.style.transform = 'translate(calc(-50% + '+dx+'px), -50%)';
      currentMoveX = dx/m;
      sendAction('move', {dx: currentMoveX, dy: 0});
    });
    document.addEventListener('mouseup', () => {
      if (ja) {
        ja = false;
        jk.style.transform = 'translate(-50%, -50%)';
        currentMoveX = 0;
        sendAction('move', {dx: 0, dy: 0});
      }
    });
    
    // Click Controls - Buttons  
    document.getElementById('jumpBtn').addEventListener('click', e => {
      e.preventDefault();
      sendAction('jump', {});
    });
    document.getElementById('kickBtn').addEventListener('click', e => {
      e.preventDefault();
      sendAction('kick', {});
    });
    
    // Keyboard Controls
    const keysPressed = {};
    document.addEventListener('keydown', e => {
      if (keysPressed[e.key]) return; // Evitar repetici√≥n
      keysPressed[e.key] = true;
      
      // Saltar con W, ArrowUp o Espacio
      if (e.key === 'w' || e.key === 'W' || e.key === 'ArrowUp' || e.key === ' ') {
        e.preventDefault();
        sendAction('jump', {});
      }
      // Patear con Shift o Enter
      if (e.key === 'Shift' || e.key === 'Enter') {
        e.preventDefault();
        sendAction('kick', {});
      }
      
      updateMovementFromKeys();
    });
    
    document.addEventListener('keyup', e => {
      keysPressed[e.key] = false;
      updateMovementFromKeys();
    });
    
    function updateMovementFromKeys() {
      let dx = 0;
      if (keysPressed['a'] || keysPressed['A'] || keysPressed['ArrowLeft']) dx -= 1;
      if (keysPressed['d'] || keysPressed['D'] || keysPressed['ArrowRight']) dx += 1;
      sendAction('move', {dx, dy: 0});
    }
    
    initSocket();
  </script>
</body>
</html>
